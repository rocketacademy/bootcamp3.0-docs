# 3.E.4: Bigfoot SQL M-M

## Learning Objectives

1. Understand how to set up M-M relationships in a SQL database using models and migrations with foreign keys and junction tables
2. Understand how to query M-M relationship data with Sequelize
3. Understand how to access data in the junction table using Sequelize

## Introduction

We will add categories to our Bigfoot sightings to make it easier for researchers to categorise sighting data. There will be an M-M relationship between categories and sightings.

## Setup

If you haven't already, complete Exercise Setup for the prior Bigfoot SQL exercise. This exercise will use the same frontend and backend repos and the same setup.

## Base: Add Categories to Sightings

We will follow a similar workflow to Bigfoot SQL 1-M in adding a new model, routes and frontend elements to support the categories feature.

### Create `Category` model, associate with `Sighting`

Create a new model `Category` to store sighting categories with `npx sequelize model:generate`, which will also create a corresponding migration. Reminder that our model names are Title Case with first letter capitalised. `Category` should have a `name` attribute of type `string`.

Update `Category` and `Sighting` models to include a `belongsToMany` association from each to the other, using the `through` option to specify junction table name `SightingCategories`.

Create a new migration file for the `SightingCategories` junction table with `npx sequelize migration:generate`. Name the migration file with the same convention as the previous migration files, e.g. `create-sightingcategories`.

Update the migration for `SightingCategories` to create the junction table with `id`, `SightingId`, `CategoryId`, `createdAt` and `updatedAt` attributes. Reference past migration files for `Sightings` and `Comments` tables for format of boilerplate attributes like `id`, `createdAt` and `updatedAt` and foreign key attributes like `SightingId` and `CategoryId`. Remember to include the reverse instructions to drop the table in the `down` function, and verify our table name strings are accurate.

Reminder to update file extensions to be `.cjs` so that our app that expects ES6 modules by default can execute files with CommonJS syntax.

Run migrations with `npx sequelize db:migrate` and verify in our SQL client that our tables are what we expect. This would be a good time to commit changes to keep our commits small and with the app in working condition. Remember to include a short and descriptive commit message.

### Write backend routes for categories

#### Clarify app requirements before creating backend routes

Before we start writing routes, let's understand app requirements and decide on inputs and outputs for our categories APIs.&#x20;

We will need to add and remove categories when creating or editing sightings. We will use the [React Select library](https://react-select.com/home) in our frontend for users to select and create categories. We will use [React Select Async functionality](https://react-select.com/home#async) to query for category options for a user to select, and we will use [React Select Creatable functionality](https://react-select.com/home#creatable) to create category options on the fly.

The above requirements mean we need 2 new routes: one to retrieve all categories and another to create a new category. We will also need to update our sighting creation route and sighting edit route (if any) to create relevant new categories and associate specified categories with sightings.

Let's start by creating the new routes to retrieve and create categories.

#### Create routes to retrieve and create categories

#### Update sighting creation and edit routes to associate relevant categories with the relevant sighting

### Update frontend to filter sightings by category

### Update frontend to specify and create categories on sighting creation

## Comfortable: Edit Sighting Categories

## More Comfortable: Add Category Intensity

## Submission

Submit pull requests to the `main` branches of Rocket's Bigfoot Frontend and Bigfoot SQL Backend repos respectively, and share your PR links in your section Slack channel.

## Deployment

### Heroku deploy instructions

Deploying the [base MVC (and Webpack) app](https://github.com/rocketacademy/webpack-mvc-base-bootcamp) is the same as deploying previous apps to Heroku with one difference- the database.

When using Sequelize we need to have different configs for connecting to the Heroku Postgres instance. Those configs are here: [https://github.com/rocketacademy/webpack-mvc-base-bootcamp/blob/main/config/config.js#L9-L19](https://github.com/rocketacademy/webpack-mvc-base-bootcamp/blob/main/config/config.js#L9-L19)

```javascript
// ...
//
production: {
  use_env_variable: 'DATABASE_URL',
  dialect: 'postgres',
  protocol: 'postgres',
  dialectOptions: {
    ssl: { // https://github.com/sequelize/sequelize/issues/12083
      require: true,
      rejectUnauthorized: false,
    },
  },
},
// ...
```

and here: [https://github.com/rocketacademy/webpack-mvc-base-bootcamp/blob/main/models/index.mjs#L12-L24](https://github.com/rocketacademy/webpack-mvc-base-bootcamp/blob/main/models/index.mjs#L12-L24)

```javascript
if (env === "production") {
  // Break apart the Heroku database url and rebuild the configs we need
  const { DATABASE_URL } = process.env;
  const dbUrl = url.parse(DATABASE_URL);
  const username = dbUrl.auth.substr(0, dbUrl.auth.indexOf(":"));
  const password = dbUrl.auth.substr(
    dbUrl.auth.indexOf(":") + 1,
    dbUrl.auth.length
  );
  const dbName = dbUrl.path.slice(1);
  const host = dbUrl.hostname;
  const { port } = dbUrl;
  config.host = host;
  config.port = port;
  sequelize = new Sequelize(dbName, username, password, config);
}
```

These are all included configs that don't need to be changed.

### Initialising the DB

To get your Sequelize database running on Heroku, run the Sequelize commands within the Heroku system. (No need to create the database, that's already been done when you provision the Postgres add-on.)

```
heroku run npx sequelize-cli db:migrate
```

```
heroku run npx sequelize-cli db:seed:all
```

## Reference Solution

Here is reference code for the frontend and the backend for this exercise, and here is a reference deployment. You can do better!
